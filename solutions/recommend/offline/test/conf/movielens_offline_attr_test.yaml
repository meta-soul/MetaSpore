apiVersion: metaspore/v1
kind: CBAttrJob
metadata:
  name: CBAttr-I2I
  category: Match/CBCF/CBAttr-I2I
  pipeline_nodes:
    - class: Attribute2INode

spec:
  spark:
    session_confs:
      app_name: 'CBCF-Attribute Pipeline'
      spark.executor.memory: '6G'
      spark.executor.instances: '2'
      spark.executor.cores: '4'
      spark.default.parallelism: '100'
  
  data:
    input:
      #item_data: ../data/ml-1m-schema/item.train
      #action_data: ../data/ml-1m-schema/action.train
      item_data: s3://dmetasoul-bucket/demo/datasets/moviedata-10m-schema/item.train
      action_data: s3://dmetasoul-bucket/demo/datasets/moviedata-10m-schema/action.train
    dump:
      #item_attr_data: ../data/ml-1m-dump/item.attr
      #item_rtag_data: ../data/ml-1m-dump/item.rtag
      #user_attr_data: ../data/ml-1m-dump/user.tag
      item_attr_data: s3://dmetasoul-bucket/demo/datasets/moviedata-10m-dump/item.attr
      item_rtag_data: s3://dmetasoul-bucket/demo/datasets/moviedata-10m-dump/item.rtag
      user_attr_data: s3://dmetasoul-bucket/demo/datasets/moviedata-10m-dump/user.tag
  
  jobs:
    item_attr:
      run:
        status: true
        scene_id: ml-cb-100
        action_type: rating
        action_value_min: 0.0
        action_value_max: 9999999.0
        tag_max_len: 5000
        write_mode: overwrite
      push_attr:
        status: true
        mongo_uri: mongodb://172.31.37.47:27017
        mongo_database: jpa
        mongo_collection: movielens_cb_demo_item_attr
        write_mode: overwrite
        fields: 
        - item_id
        - tags
        - weight
        - popularity
        index_fields: 
        - item_id
      push_rtag:
        status: true
        mongo_uri: mongodb://172.31.37.47:27017
        mongo_database: jpa
        mongo_collection: movielens_cb_demo_item_rtag
        write_mode: overwrite
        fields:
        - tag
        - item_ids
        index_fields:
        - tag
  
    user_attr:
      run:
        status: true
        scene_id: ml-cb-100
        action_type: rating
        action_value_min: 0.0
        action_value_max: 9999999.0
        action_sortby_key: action_time
        action_max_len: 3
        user_tags_topk: 10
        write_mode: overwrite
      push_attr:
        status: true
        mongo_uri: mongodb://172.31.37.47:27017
        mongo_database: jpa
        mongo_collection: movielens_cb_demo_user_emb
        write_mode: overwrite
        fields: 
        - user_id
        - tags
        - tag_weights
        index_fields: 
        - user_id
